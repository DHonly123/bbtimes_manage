<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>教师详情</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<script src="../scripts/boot.js" type="text/javascript"></script>
<script type="text/javascript" src="../scripts/amcharts/amcharts.js"></script>
<script type="text/javascript" src="../scripts/amcharts/serial.js"></script>
<style type="text/css">
	body {
		font-size: 12px;
		color: black;
	}
	
	a:link {
		color: #84c4e2;
	}
	
	a:visited {
		color: #84c4e2;
	}
	
	a:hover {
		color: #cd82ad;
	}
	
	a:active {
		color: #84c4e2;
	}
</style>
<style type="text/css">
fieldset {
	border: solid 1px #aaa;
}

.hideFieldset {
	border-left: 0;
	border-right: 0;
	border-bottom: 0;
}

.hideFieldset .fieldset-body {
	display: none;
}

div#photo {
	height: 180px;
	width: 150px;
	float: left;
}

div#baseinfo {
	float: left;
	margin-left: 50px;
}

.Personal_t {
	border: 1px solid #CCC;
	-webkit-border-radius: 3px;
	-moz-border-radius: 3px;
	border-radius: 3px;
	background-color: #FFF;
	padding: 5px;
	-webkit-box-shadow: 0px 2px 4px rgba(0, 0, 0, .05);
	-moz-box-shadow: 0px 2px 4px rgba(0, 0, 0, .05);
	box-shadow: 0px 2px 4px rgba(0, 0, 0, .05);
	position: relative;
	z-index: 33;
}

.Personal_a {
	font-family: "微软雅黑", "宋体";
	background-color: #6b6b6b;
	width: 150px;
	height: 30px;
	font-size: 14px;
	color: #FFF;
	margin-top: 5px;
	line-height: 30px;
	text-align: center;
	-webkit-border-radius: 3px;
	-moz-border-radius: 3px;
	border-radius: 3px;
}

.Personal_a a {
	color: #FFF;
	text-decoration: none;
}

body {
	margin: 0;
	padding: 0;
	border: 0;
	width: 100%;
	height: 100%;
}
</style>
</head>
<body>
	<div class="mini-toolbar">
		<a class="mini-button" iconCls="icon-save" onclick="onOk" plain="true">保存</a>
		<span class="separator"></span> 
		<a class="mini-button" iconCls="icon-remove" onclick="onCancel" plain="true">取消</a>
	</div>

	<fieldset id="fd1">
		<legend>
			<span>基本信息</span>
		</legend>
		<div class="fieldset-body">
			<div id="photo" class="Personal_t">
				<div style="width: 150px; height: 150px;">
					<img id="header" style="width: 150px; height: 150px;" src=""
						onerror="javascript:this.src='../images/default_man.jpg'">
				</div>
				<div class="Personal_a">
					<a href="javascript:uploadPhoto()">更改个人资料照片</a>

				</div>
			</div>
			<form id="form1" method="post">
				<div id="baseinfo">
					<table class="form-table" border="0" cellpadding="1"
						cellspacing="2">
						<tr>
							<td class="form-label" style="width: 80px;">部门：</td>
							<td style="width: 150px;"><input id="dept"
								name="buser.DeptID" class="mini-combobox"
								value="${(teacher.DeptID)!}" valueField="ID"
								textField="Caption" required="true" /></td>
							<td class="form-label" style="width: 80px;">姓名：</td>
							<td style="width: 150px"><input name="buser.DisplayName"
								value="${(teacher.DisplayName)!}" class="mini-textbox"
								required="true" /></td>
						</tr>
						<tr>
							<td class="form-label" style="width: 80px;">性别：</td>
							<td style="width: 150px;"><input name="buser.SexID"
								class="mini-combobox" value="${(teacher.SexID)!}"
								valueField="DetailID" textField="Caption"
								url="../kind/getSexType" required="true" /></td>
							<td class="form-label" style="width: 80px;">手机：</td>
							<td style="width: 150px"><input name="buser.PhoneMobile"
								value="${(teacher.PhoneMobile)!}" class="mini-textbox"
								required="true" vtype="rangeLength:11,12" /></td>
						</tr>
						<tr>
							<td class="form-label" style="width: 80px;">卡号1：</td>
							<td style="width: 150px"><input name="buser.CardNO"
								value="${(teacher.CardNO)!}" class="mini-textbox"/></td>
							<td class="form-label" style="width: 80px;">卡号2：</td>
							<td style="width: 150px"><input name="buser.CardNO2"
								value="${(teacher.CardNO2)!}" class="mini-textbox"/></td>
						</tr>
						<tr>
							<td class="form-label" style="width: 80px;">卡号3：</td>
							<td style="width: 150px"><input name="buser.CardNO3"
								value="${(teacher.CardNO3)!}" class="mini-textbox"/></td>
							<td></td>
							<td></td>
						</tr>
						<tr>
							<td style="display: none;"><input name="buser.ProfileID"
								value="${(teacher.ProfileID)!}" class="mini-textbox"
								required="true" /></td>
							<td style="width: 150px; display: none;"><input
								name="buser.UserType" class="mini-textbox"
								value="${(teacher.UserType)!}" required="true" /></td>
							<td style="width: 150px; display: none;"><input
								name="buser.isGenerate" class="mini-textbox"
								value="${(teacher.isGenerate)!}" required="true" /></td>	
						</tr>
					</table>
				</div>
			</form>
		</div>
	</fieldset>
	<div id="tabs" class="mini-tabs" activeindex="0"
		style="width: 100%; height: 290px;">
		<div title="刷卡记录" iconcls="icon-node">
			<div class="mini-fit" style="height: 280px;">
				<div id="datagrid1" class="mini-datagrid"
					url="../card/getRecordDetailByUserID" idField="DetailID" showPager="false"
					style="width: 100%; height: 100%;">
					<div property="columns">
						<div type="indexcolumn"></div>
						<div field="UserName" width="120" headerAlign="center"
							allowSort="true">姓名</div>
						<div field="CardNumber" width="120" headerAlign="center"
							allowSort="true">卡号</div>
						<div field="RecordTime" width="100" align="center"
							headerAlign="center" dateFormat="yyyy-MM-dd HH:mm:ss">刷卡时间</div>
					</div>
				</div>
			</div>
		</div>
		<div title="用户发图统计" iconcls="icon-node">
			<div class="mini-fit" style="height: 280px;">
				<div id="chartcontainer" style="width: 100%; height: 100%;"></div>
			</div>
		</div>
		<div title="任教班级" iconcls="icon-node">
			<div class="mini-fit" style="height: 280px;">
				<div id="datagrid2" class="mini-datagrid"
					url="../user/getTeacherClass" idField="id" showPager="false"
					style="width: 100%; height: 100%;">
					<div property="columns">
						<div type="indexcolumn"></div>
						<div field="ClassName" width="120" headerAlign="center"
							allowSort="true">班级</div>
						<div field="studentCount" width="120" headerAlign="center"
							allowSort="true">学生人数</div>
						<div field="SchoolName" width="100" align="center"
							headerAlign="center">学校</div>
					</div>
				</div>
			</div>
		</div>
		
		<div title="平台使用统计" iconcls="icon-node">
			<div class="mini-fit" style="height: 280px;">
				<div id="datagrid3" class="mini-datagrid"
					url="../user/getUserCallRecord" idField="ID" showPager="false"
					style="width: 100%; height: 100%;">
					<div property="columns">
						<div type="indexcolumn"></div>
						<div field="OP_TIME" width="150" headerAlign="center" dateFormat="yyyy-MM-dd HH:mm:ss"
							allowSort="true">操作时间</div>
						<div field="OP_TYPE" width="100" headerAlign="center"
							allowSort="true">操作类型</div>
						<div field="C_Type" width="100" align="center"
							headerAlign="center">客户端机型</div>
						<div field="C_Version" width="100" align="center"
							headerAlign="center">客户端版本</div>	
					</div>
				</div>
			</div>
		</div>
	</div>

		<script type="text/javascript">
			mini.parse();
			var grid1 = mini.get("datagrid1");
			var grid2 = mini.get("datagrid2");
			var grid3 = mini.get("datagrid3");
			var userID = mini.getParams().userID;
			var schoolId = readCookie("bbm_usercookie", 3, "&");
			$('#header').attr('src', baseHeader('${(teacher.UserID)!}'));
			var dep = mini.get("dept");
			$.getJSON("../dept/getDeptList", {
				schoolID : schoolId
			}, function(data) {
				if (data != null) {
					var data_array = new Array();
					for (var i = 0; i < data.length; i++) {
						if ('0' != data[i].PID || 0 != data[i].PID) {
							data_array.push(data[i]);
						}
					}
					dep.setData(data_array);
				}
			});
			grid1.load({
				profileID : ${(teacher.ProfileID)!}
			});
			grid2.load({
				userID : userID
			});
			grid3.load({
				userID : userID
			});
			
			initAnalysis(); //初始化图形
			function toggleFieldSet(ck, id) {
				var dom = document.getElementById(id);
				dom.className = !ck.checked ? "hideFieldset" : "";
			}
			
			var form = new mini.Form("form1");
			function SaveData() {
				form.validate();
				if (form.isValid() == false)
					return;
				$.ajax({
					url : "../user/update",
					type : "post",
					data : $("#form1").serialize(),
					cache : false,
					dataType : "json",
					success : function(data) {
						CloseWindow("save");
						mini.alert(data);
					},
					error : function(jqXHR, textStatus, errorThrown) {
						mini.alert(jqXHR.responseText);
						CloseWindow();
					}
				});
			}

			function CloseWindow(action) {
				if (action == "close" && form.isChanged()) {
					if (confirm("数据被修改了，是否先保存？")) {
						return false;
					}
				}
				if (window.CloseOwnerWindow)
					return window.CloseOwnerWindow(action);
				else
					window.close();
			}
			function onOk(e) {
				SaveData();
			}
			function onCancel(e) {
				CloseWindow("cancel");
			}

			function uploadPhoto() {
				mini.open({
					url : "user/photo.html?id=${(teacher.UserID)!}&type=02",
					title : "用户头像修改",
					width : 820,
					height : 600,
					onload : function() {
					},
					ondestroy : function(action) {
						$("#header").attr("src",
								baseHeader('${(teacher.UserID)!}'));
					}
				});
			}
			
			function initAnalysis() {
				$.ajax({
					url : "../report/userTrend",
					data : {
						userID : '${(teacher.UserID)!}'
					},
					type : "post",
					success : function(result) {
						var charData = JSON.parse(JSON.stringify(result));
						var chart = new AmCharts.AmSerialChart();
	                    chart.dataProvider = charData;
	                    chart.categoryField = "label";

	                    var graph = new AmCharts.AmGraph();
	                    graph.valueField = "value";
	                    graph.type = "column";
	                    graph.lineAlpha = 0;
	                    graph.fillAlphas = 0.8;
	                    chart.addGraph(graph);

	                    chart.write("chartcontainer");
					},
					error : function() {

					}
				});
			}

			function int_() {
				$.getJSON("../report/user_bar", {
					userID : '${(teacher.UserID)!}'
				}, function(data) {
					var data_new = [];
					var colors = new Array();
					for (var i = 0; i < data.length; i++) {
						var data_ = [];

						data_.push(insert_flg(data[i].dataTime.toString(), "-",
								4)
								+ '月');
						data_.push(data[i].value * 1);
						data_new.push(data_);
						var color = getRandomColor();
						colors.push(color);
					}
					var myChart = new JSChart('chartcontainer', 'bar');
					myChart.setDataArray(data_new);
					myChart.setTitle('月消息发送统计');
					myChart.colorizeBars(colors);
					myChart.setAxisColor('#9D9F9D');
					myChart.setAxisWidth(1);
					myChart.setAxisNameX('月份');
					myChart.setAxisNameY('消息发送数量');
					myChart.setAxisNameColor('#655D5D');
					myChart.setAxisNameFontSize(9);
					myChart.setAxisPaddingLeft(50);
					myChart.setAxisValuesDecimals(1);
					myChart.setAxisValuesColor('#9C1919');
					myChart.setTextPaddingLeft(0);
					myChart.setBarValuesColor('#9C1919');
					myChart.setBarBorderWidth(0);
					myChart.setTitleColor('#8C8382');
					myChart.setGridColor('#5D5F5D');
					myChart.setSize(760, 280);
					myChart.draw();
				})
			}
			var getRandomColor = function() {
				return (function(m, s, c) {
					return (c ? arguments.callee(m, s, c - 1) : '#')
							+ s[m.floor(m.random() * 16)]
				})(Math, '0123456789abcdef', 5)
			}
			function insert_flg(str, flg, sn) {
				var newstr = "";
				for (var i = 0; i < str.length; i += sn) {

					var tmp = str.substring(i, i + sn);
					newstr += tmp + flg;
				}

				return newstr;
			}
		</script>
</body>
</html>
